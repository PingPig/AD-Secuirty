# Windows特权升级：第二部分-域管理员特权

## 讲在前面:

窃取域内其他用户的身份的技术对某些安全人员来说似乎一种很厉害的操作，但其实任何一个了解Windows工作原理的用户都可以做到这一点

文章其实分两个部分，第1部分\(本条目\)讨论从非特权用户帐户获得本地系统和管理特权，第2部分将重点讨论从本地管理员或域用户帐户获得域管理特权。

这篇文章重点讲从本地管理员账户升级到域管理特权的部分技巧，现在看来这些技巧都是一些老掉牙的操作，但是有必要重新拿出来回味一下。

## 破解本地LM密码Hash

在Windows2008以前，计算机都使用的是在当时看来非常强壮的LM\(LAN Manager Hash\)加密算法，当时的攻击者尝试使用字典来暴力破解的方式来获得密码，这会花费其大量的时间，还不能保证一定会破解成功。在当时网络管理员认为使用LM加密算法非常安全，但就像我之前文章里说的那样，攻击者的方式随着时间的流逝是在层出不穷不断变化，现在使用类似Rainbow table这样的工具会让LM加密的密码Hash在几分钟内被破解。

正常情况下大家都会偷懒，所以域服务帐户通常会在在整个环境中使用相同的密码安装本地服务帐户，虽然一时工作效率提高了，但也埋下了安全隐患：经验丰富的攻击者察觉到服务账户可被利用时，一旦利用其提权成功，就会造成域网络的沦陷。

域帐户域帐户之所以受欢迎，有很多原因：

* 首先，他们通常为渗透测试人员提供在域上足够的特权，以查找其他用户帐户以针对将来的攻击，例如域管理员。
* 其次，它们通常为测试人员提供对未正确锁定的共享的访问权限。
* 最后，它们提供了一种登录到其他系统的方法，例如域控制器和成员服务器。
* 目前，只要使用的是2008以上版本机器的默认都是NTLM加密算法进行加密。

## 使用“哈希传递（Pth）”来模拟用户

当我们在主机上获取到了hash但却无法破解出来时，使用hash传递便成为了最香的办法，工具非常多包括但不限于：MSF,CS,impacket工具集,mimikatz等。除此之外也有票据传递（Ptt）

## 键盘记录

在已渗透的主机上安装键盘记录是每个安全从业耳熟能详的操作，它可以在你万念俱灰的时候给你带来一丝希望，不过这个操作需要管理员权限且容易被windows defender检测，所以对键盘记录程序做好免杀是非常重要的，或者你可以大胆一点在defender中将程序设置为例外。

## 在本地主机上安装嗅探器

安装网络流量嗅探器这一攻击手段不仅对网络流量进行收集，还可以作为收集系统、应用程序和网络设备密码的重要载体。不过此类设备都需要管理员启动并且需要主动为计算机安装用于执行混杂嗅探网络流量的WinPcap驱动程序。通常，在网络中，唯一能嗅探到的流量是广播流量和流经本地主机的流量

目前有许多优秀的开源和商业嗅探工具。笔者建议安装完整的WinPcap和Wireshark。Wireshark是为许多平台制作的，有很多不错的选择，而且是免费的。或者如果你喜欢更隐蔽的安装方法，我建议使用WinDump \(Windows TCPDump的Windows端口\)和Windows Nmap zip包附带的WinPcap发行版，因为它们都可以在没有GUI的情况下悄无声息地安装。

##  

## 从网络设备嗅探

经验不足的渗透测试人员常常会忽视一个重要的攻击点就是路由器和交换机。通常，这两种设备类型都可以复制网络流量并将其定向到网络上的任何位置以进行嗅探。在某些情况下，测试人至可员甚以直接在设备本身上监视和查看流量。笔者有些奇怪，大部分企业将设备购买启用后一般都继续使用默认密码和SNMP字符串或者企业并不担心这些网络设备被攻陷，事实上大多数TFTP服务器不使用身份验证，这意味着可以下载映像，并且可以读取或破解设备密码以获得完全访问权限

## 中间人（MITM）攻击

中间人攻击（Man-in-the-MiddleAttack，简称“MITM攻击”）是一种“间接”的入侵攻击，这种攻击模式是通过各种技术手段将受入侵者控制的一台计算机虚拟放置在网络连接中的两台通信计算机之间，这台计算机就称为“中间人

进行MITM攻击的最简单方法之一是ARP欺骗。这是一种简单的攻击，有很多免费工具可以支持它，但是许多公司仍然无法防范它。如果你不熟悉，我建议您可以仔细对该漏洞进行深入研究。

利用ARP欺骗漏洞的工具非常多，例如arpspoof。它在某些情况下，MITM攻击可能比所有其他升级手段更有效。嗅探正确的密码可能需要花费一些时间，但这不影响你多进程工作。

## 直接攻击域控制器

在渗透测试中，如果我们可以和域控制器通信，笔者建议直接对它下手。在域控制器上获得几乎任何级别的用户访问权限通常都会导致域管理员访问权限。请记住，域控制器上的SYSTEM级访问等效于域管理员访问。渗透测试人员可以轻松利用SYSTEM访问来创建自己的域管理员帐户。

## 在线资源

我们在渗透测试的过程中始终离不开在互联网搜索的这一步骤，该步骤贯穿整个渗透的过程，有时候不经意的一次搜错甚至会出现意外的惊喜。很多企业的管理员或IT部门对于公开的信息以及企业的外部网站脱敏不够、防护不全，这样的工作自然而然的就导致了攻击者会进行联想或利用搜集到的信息扩大攻击面或生成字典进行暴力破解

## [社会工程学](https://www.netspi.com/security-testing/attack-simulation/social-engineering-2/)

无可厚非的是国内所有安全从业人员都知道社会工程学这个学科，但很少有人将其用到极致或灵活运用，在获得域管理员权限的过程中，使用社会工程学往往是最有效、最快速的办法。同时笔者在此也简单概述一下何为社会工程学。但存在三种主要的媒介：

**面对面：**

通常攻击者会做好充分的准备，构建特定的场景，伪造一个可信的身份来利用人们普遍的心理，攻击者甚至可以光明正大的走进你的数据中心安装恶意插件、后门或键盘记录器或直接向你索取密码等，在一个经验丰富且极具伪装的人面前，我们谁都是一个被骗的小孩子。

**使用电话：**

如果你精心准备好了一次欺骗的工作并且选好了攻击目标。在笔者看来，就目前国内的安全氛围下，只要不是傻子，在拥有健全的公司安全制度管理下，使用电话进行社会工程学想要成功很难。

**使用电子邮件（QQ、WeChat等）：**

在足不出户的远程操作下，发送钓鱼邮件或利用沟通媒介发送恶意后门往往是十分有效的操作。其非常突出的特点是它可以批量的向大量人员进行发送，企业员工在攻击者精心准备的说辞诱骗下点击了后门或恶意链接，就会直接导致攻击者进入内部网络，达到事半功倍的效果。

当然渗透测试中不能已社会工程学为主，要将其和强大的技术能力以及丰富的技术经验结合起来，才能在渗透测试过程中如鱼得水。

## 结论

获得域管理员权限并不是只要会利用厉害的工具就可以了，虽然工具有时候确实能帮助我们事半功倍，但更多的是需要我们积累的经验和一颗全心全意的心。

