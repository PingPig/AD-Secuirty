# 回顾的Active Directory安全问题及其解决方法

## 讲在前面：

在笔者能力所及范围内所接触到的渗透目标都有不同的特点：不存两个一模一样的内网环境，但都会存在相同的安全问题，这些问题国内外都有不同的研究者进行研究并发布了优秀的论文，其中都会指出这些问题源自Microsoft较老版本的企业管理平台。

我们必须要明白的一个实事是："随着时间的流逝，攻击方式在不断地变化，层出不穷，但我们使用的系统和网络的管理方式并没有发生太大改变，即使内部系统经常遭到破坏，但我们却并没有能够引起足够的重视，并且依旧在进行一些没有改变错误的维护操作和配置。不过值得一提的是，近些年来越来越多的企业制定了内部”安全攻防演练“制度，以此来提高安全防护能力。"

### 注意： <a id="%E6%B3%A8%E6%84%8F%EF%BC%9A"></a>

在攻防演练中，作为防守方，我们需要提前假设攻击者已经控制了企业内网的计算机，并且已经开始了横向移动扩大攻击面。[假想威胁](https://azure.microsoft.com/en-us/blog/red-teaming-using-cutting-edge-threat-simulation-to-harden-the-microsoft-enterprise-cloud/?rnd=1)

我们在描述Active Directory的风险和缓解措施时，同样也包括如何在企业中对人和制度进行风险考核及缓解。

以下是AD常见的安全问题列表，该列表并不完全并且已经有些年头，但反映了企业常见的问题，是时候拿出来进行重新审慎。

## AD常见的安全问题列表 <a id="AD%E5%B8%B8%E8%A7%81%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E5%88%97%E8%A1%A8"></a>

### 认为Active Directory域就是安全边界 <a id="%E8%AE%A4%E4%B8%BAActive%20Directory%E5%9F%9F%E5%B0%B1%E6%98%AF%E5%AE%89%E5%85%A8%E8%BE%B9%E7%95%8C"></a>

**风险：**

对内网安全边界的认识错误会直接影响到安全人员对域环境的设计，笔者就曾认为内网的安全边界就是AD域的边界，这样认识会造成在搭建域环境之初就埋下了安全风险。虽然Active Directory林可以建立多个域来缓解某些域安全问题，但是由于存在域信任规则再加上安全人员可能对域信任规则的认识不够深入，安全风险其实并不会得到缓解。

[Microsoft描述了什么是AD林：](https://technet.microsoft.com/en-us/library/cc759073%28v=ws.10%29.aspx)

> 林是Active Directory的完整实例。每个林都充当顶级容器，因为它包含该Active Directory实例中的所有域容器。一个林可以包含一个或多个域对象，所有这些都共享一个公共的逻辑结构、全局编录、目录架构和目录配置、以及自动的双向传递信任关系。林中的第一个域称为林根域。该域的名称指的是森林，例如pingpig.com。默认情况下，Active Directory中的信息仅在目录林内共享。所以，林才是该Active Directory实例的安全边界。

**缓解：**

* 企业内部在建设域环境之初需要规避目前已公开的安全威胁并做好预防将会发生的威胁
* 在实际情况中在域内进行权限赋予时进行考虑充分：包括但不限于将会或可能发生的安全隐患。
* 聘请经验丰富的域安全专家评估域环境

### 使用默认设置部署系统 <a id="%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AE%E9%83%A8%E7%BD%B2%E7%B3%BB%E7%BB%9F"></a>

**风险：**

使用默认配置来建设内网环境，一叶障目的认为默认安全配置是最安全的。需要介绍的是，微软致力于跨产品（包括较旧产品）的兼容性，这表示你需要调整安全设置来提高环境的安全性。传统安全配置仍然是现代网络上最大的安全问题之一

**缓解：**

* 不要使用默认配置，可以自定义安全配置
* 及时更新系统版本，新的系统版本通常拥有更加安全的默认配置

### 域管理员太多 <a id="%E5%9F%9F%E7%AE%A1%E7%90%86%E5%91%98%E5%A4%AA%E5%A4%9A"></a>

**风险：**

Active Directory的管理在理想情况下应该由少数管理员来进行，但域管理员账户的数量在实际工作中却会形成人尽是管理的样子。我们都知道域管理员的权限是非常大的，它可以完全并且不受限的管理域，包括管理所有工作站、服务器、域控制器、活动目录、默认组策略等，相比企业内其他账户来说这些权限都是非常大的

**缓解：**

* 理想情况下，Domain Admin组应该为空
* 审慎的审核每一个想要加入Domain Admin组的账户
* 确保每个角色仅具有执行与该角色关联的任务所需的权限
* [使用紧急访问账户](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-emergency-access)

### 不跟踪/监视/记录对Active Directory的委派访问 <a id="%E4%B8%8D%E8%B7%9F%E8%B8%AA%2F%E7%9B%91%E8%A7%86%2F%E8%AE%B0%E5%BD%95%E5%AF%B9Active%20Directory%E7%9A%84%E5%A7%94%E6%B4%BE%E8%AE%BF%E9%97%AE"></a>

**风险：**

在委派给某些账户/组访问特定的服务后，我们需要定时的监控和记录这些委派是否已正确执行，账户访问有无异常以确保Active Directory的安全

**缓解：**

* 创建自定义组，并为这些组委派特定的访问权限
* 定期审核组及其访问的资源
* 不要使用现有的默认组将权限委派给自定义组
* 适当利用委派来确保每个管理员组都有适当的权限

### 过度使用的服务帐户 <a id="%E8%BF%87%E5%BA%A6%E4%BD%BF%E7%94%A8%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%B8%90%E6%88%B7"></a>

**风险：**

事实上Domain Administrator提供的一整套权限使用户使用的产品更容易测试和部署，但用户一直要求为服务帐户提供域管理权限，即使实际并不需要，这样会产生例如某个服务账户被攻陷，则域可能因为这个服务账户沦陷而迅速受到大规模攻击

**缓解：**

* 确保每个服务帐户只被委派所需的权限

### 密码少于20个字符的服务帐户 <a id="%E5%AF%86%E7%A0%81%E5%B0%91%E4%BA%8E20%E4%B8%AA%E5%AD%97%E7%AC%A6%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%B8%90%E6%88%B7"></a>

**风险:**

存在漏洞Kerberoasting请求服务账户加密的TGS服务票证，将其导出后进行离线爆破服务账户的密码，用来权限提升

**缓解:**

* 确保所有服务帐户都必须具有包含20个字符（或更多）的密码
* 配置密码长度最小值策略（密码长度最小值策略仅在将域功能级别配置为Windows Server 2008或更高版本后可用。）

### 使用组策略首选项来管理凭据（极度危险） <a id="%E4%BD%BF%E7%94%A8%E7%BB%84%E7%AD%96%E7%95%A5%E9%A6%96%E9%80%89%E9%A1%B9%E6%9D%A5%E7%AE%A1%E7%90%86%E5%87%AD%E6%8D%AE%EF%BC%88%E6%9E%81%E5%BA%A6%E5%8D%B1%E9%99%A9%EF%BC%89"></a>

**风险：**

组策略首选项提供以下功能：更改计算机上的本地管理员帐户密码，创建本地帐户，部署计划任务，创建服务等。问题在于，虽然凭据存储在域中每个域控制器上SYSVOL共享中的XML文件中，但因其共享的机制以及微软公布其加密算法的原因，凭据随可以被破解。这是最常见的凭证盗窃场景之一，我经常在SYSVOL中的组策略首选项文件\(以及VBS脚本\)中发现密码。

**缓解：**

不要使用"组策略首选项"来增改域内用户的密码，已使用的请尽快删除该策略并删除SYSVOL共享中的XML文件

### 在域控制器上运行不必要的角色和服务 <a id="%E5%9C%A8%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B8%8A%E8%BF%90%E8%A1%8C%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84%E8%A7%92%E8%89%B2%E5%92%8C%E6%9C%8D%E5%8A%A1"></a>

域控制器应该安装有限的软件和代理，包括角色和服务。在域控制器上运行的非必需的代码会对企业的Active Directory环境造成威胁。

域控制器应只运行必需的软件、服务和至关重要的角色，例如DNS服务。

### 域控制器未及时打补丁 <a id="%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E6%9C%AA%E5%8F%8A%E6%97%B6%E6%89%93%E8%A1%A5%E4%B8%81"></a>

如果没有及时地将关键/高级补丁应用到所有域控制器，则整个域和森林将处于危险之中。MS14-068就是一个很好的例子，说明了不及时正确的打补丁会给AD森林带来不可预料的风险。

### 未打补丁的系统（服务器和工作站） <a id="%E6%9C%AA%E6%89%93%E8%A1%A5%E4%B8%81%E7%9A%84%E7%B3%BB%E7%BB%9F%EF%BC%88%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%B7%A5%E4%BD%9C%E7%AB%99%EF%BC%89"></a>

根据[2015年初发布的2014年Verizon数据泄露调查报告](http://www.verizonenterprise.com/DBIR/)，在利用的漏洞中有99％都有超过一年的补丁可用。实际上，每个组织都需要确定如何在几天之内快速将关键/高级补丁部署到所有系统，以及在不久之后将低严重性补丁部署到所有系统。

**举个例子：**

未修补的系统存在本地升级漏洞的话就会使攻击者能够快速获得计算机上的管理员权限，这通常会导致凭证被盗。在当前的威胁环境下，在厂商发布补丁后几个月都没有打补丁的系统是不现实的，特别是对于高/关键评级的补丁。

### 域控制器没有及时更新操作系统版本 <a id="%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8%E6%B2%A1%E6%9C%89%E5%8F%8A%E6%97%B6%E6%9B%B4%E6%96%B0%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%89%88%E6%9C%AC"></a>

在Windows Server的每个后续版本中，Microsoft都引入了其他安全增强功能，这些功能大大改善了Active Directory的安全状态。一旦安装了操作系统，其中一些安全功能便可用，而将域/林功能级别设置为更高时，其他安全功能就可用。

Windows版本在此处列出了一些Active Directory域功能级别的安全功能：

**Windows Server 2008 R2域功能级别：**

* [Kerberos AES加密支持](http://blogs.msdn.com/b/openspecification/archive/2011/05/31/windows-configurations-for-kerberos-supported-encryption-type.aspx)
  * 支持从[支持的类型](http://blogs.msdn.com/b/openspecification/archive/2011/05/31/windows-configurations-for-kerberos-supported-encryption-type.aspx)中删除RC4 HMAC Kerberos加密。请注意，Windows 7和Windows Server 2008 R2[不再支持Kerberos DES加密](https://technet.microsoft.com/en-us/library/dd560670%28v=ws.10%29.aspx)。
* [托管服务帐户](http://blogs.technet.com/b/askds/archive/2009/09/10/managed-service-accounts-understanding-implementing-best-practices-and-troubleshooting.aspx)
  * AD控制服务帐户密码。
* [认证机制的保证](https://technet.microsoft.com/en-us/library/dd391847%28v=ws.10%29.aspx)。
  * 使用智能卡进行身份验证时，用户将获得其他组成员身份

**Windows Server 2012域功能级别：**

* [组托管服务帐户](https://technet.microsoft.com/en-us/library/hh831782.aspx)
  * AD控制服务帐户密码。
* [复合身份验证和Kerberos FAST（Kerberos防护）](https://technet.microsoft.com/en-us/library/hh831747.aspx)
  * 结合用户和设备身份验证
  * 保护Kerberos AS和TGT请求。

**Windows Server 2012 R2域功能级别：**

* [身份验证策略和孤岛](https://technet.microsoft.com/en-us/library/dn486813.aspx)
  * 保护特权帐户，限制它们可以登录的位置。
* [受保护的用户安全组](https://technet.microsoft.com/en-us/library/dn466518.aspx)
  * PDC设置为Windows 2012 R2以创建组
  * 受保护的用户主机保护（Win 8.1 / 2012R2）可以防止：
    * 通过使用NTLM，摘要式身份验证或CredSSP进行身份验证。
    * 缓存的凭证
    * Kerberos预认证中的DES或RC4加密类型。
    * 帐户委派。
  * 受保护的用户域强制执行可防止：
    * NTLM身份验证。
    * Kerberos预认证中的DES或RC4加密类型。
    * 用不受约束或受约束的委托进行委派。
    * 在最初的四小时生命周期之后更新Kerberos TGT。

### 多台计算机上的相同本地管理员帐户密码 <a id="%E5%A4%9A%E5%8F%B0%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%8A%E7%9A%84%E7%9B%B8%E5%90%8C%E6%9C%AC%E5%9C%B0%E7%AE%A1%E7%90%86%E5%91%98%E5%B8%90%E6%88%B7%E5%AF%86%E7%A0%81"></a>

无论计算机是否加入Active Directory，计算机上的本地帐户都时可以登录到该计算机。有趣的是，如果多台计算机上存在相同的管理员帐户名和密码，则登录到一台计算机上的该管理员可以使用相同的凭据连接到另一台计算机。这意味着，如果攻击者在一台计算机上获得本地管理员访问权限并可以使用该凭据连接到另一台计算机，则其他计算机可能会受到威胁。当攻击者在多台计算机上拥有管理员权限时，找到具有提升权限的域凭据只是时间问题。

**举例**：密码喷洒

现在至关重要的是，确保本地管理员密码在网络上的每台计算机上都是唯一的。[Microsoft LAPS](https://adsecurity.org/?p=1790)是利用现有Active Directory功能的免费选择。

### Active Directory管理员登录到不受信任的系统 <a id="Active%20Directory%E7%AE%A1%E7%90%86%E5%91%98%E7%99%BB%E5%BD%95%E5%88%B0%E4%B8%8D%E5%8F%97%E4%BF%A1%E4%BB%BB%E7%9A%84%E7%B3%BB%E7%BB%9F"></a>

**风险：**

当恶意代码注入到网络内部的计算机中时。此恶意软件的攻击者将搜索凭据以进行窃取和重新使用。从而提升权限提来登录到网络上的各种机密计算机上，则这些系统上的凭证可能会被窃取

**缓解：**

显式地限制系统提升的凭据登录\(交互式登录\)，确保这些凭据对攻击者可能访问的系统不可用

将管理员隔离到他们所管理的系统以及特殊的管理工作站，防止管理员凭据被盗

### 不监视管理员组成员 <a id="%E4%B8%8D%E7%9B%91%E8%A7%86%E7%AE%A1%E7%90%86%E5%91%98%E7%BB%84%E6%88%90%E5%91%98"></a>

**风险：**

大多数组织都意识到，拥有管理权限的账户数量即使不是每月都在增加，也会逐年增加，而不会下降。Active Directory中的管理组需要仔细检查，特别是在添加新帐户时。

**缓解：**

使用一个在向组添加新帐户之前需要经过批准的系统。该系统还可以做到在用户的访问权限到期时从组中自动删除用户。  
在需要进行关联访问之前，将管理组保持为空。

自动化系统是限制和保护管理组成员关系的最佳方法。

### 不清除管理员组成员身份 <a id="%E4%B8%8D%E6%B8%85%E9%99%A4%E7%AE%A1%E7%90%86%E5%91%98%E7%BB%84%E6%88%90%E5%91%98%E8%BA%AB%E4%BB%BD"></a>

此项目与上一个紧密相关。管理员组成员资格需要定期检查，不再需要相关权限的帐户/组可以删除。可以利用上一项中提到的自动化系统来确保只有当前批准的成员才能在组中。

### 没有利用平台中的最新安全功能（更新的操作系统/通过补丁程序进行的增强） <a id="%E6%B2%A1%E6%9C%89%E5%88%A9%E7%94%A8%E5%B9%B3%E5%8F%B0%E4%B8%AD%E7%9A%84%E6%9C%80%E6%96%B0%E5%AE%89%E5%85%A8%E5%8A%9F%E8%83%BD%EF%BC%88%E6%9B%B4%E6%96%B0%E7%9A%84%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%2F%E9%80%9A%E8%BF%87%E8%A1%A5%E4%B8%81%E7%A8%8B%E5%BA%8F%E8%BF%9B%E8%A1%8C%E7%9A%84%E5%A2%9E%E5%BC%BA%EF%BC%89"></a>

随着Microsoft发布新的操作系统，其中包含了一些新的安全功能，这些功能可以增强环境的安全性。此外，还发布了一些补丁程序，其中包括改进的安全性设置（默认情况下未设置），应对其进行研究以确定新的设置。一个很好的例子是[“后端口”补丁KB2871997](https://adsecurity.org/?p=559)。坚持使用Windows的较早版本会限制环境的总体安全状况。

### 不会自动删除不活动的（过时的）用户和计算机帐户 <a id="%E4%B8%8D%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%88%A0%E9%99%A4%E4%B8%8D%E6%B4%BB%E5%8A%A8%E7%9A%84%EF%BC%88%E8%BF%87%E6%97%B6%E7%9A%84%EF%BC%89%E7%94%A8%E6%88%B7%E5%92%8C%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%B8%90%E6%88%B7"></a>

Active Directory中已启用的但不是活跃的用户账户或已过期但未删除的用户账户是攻击者首选的目标，这是因为这些账户还拥有其权限，可以被利用来获得对资源的访问权限而不会引起注意，当然，必须先控制该帐户。有几种方法可以接管这类帐户，因为其是一个不活跃的账户，所以不会记录使用情况

### 使旧式身份验证在网络（LM / NTLMv1）上保持活动状态 <a id="%E4%BD%BF%E6%97%A7%E5%BC%8F%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E5%9C%A8%E7%BD%91%E7%BB%9C%EF%BC%88LM%20%2F%20NTLMv1%EF%BC%89%E4%B8%8A%E4%BF%9D%E6%8C%81%E6%B4%BB%E5%8A%A8%E7%8A%B6%E6%80%81"></a>

Windows Server 2008 R2包含的功能可以帮助识别网络上使用的NTLM身份验证。完全删除这些遗留的身份验证协议（LM / NTLMv1）非常重要，因为它们是不安全的。

可以通过使用组策略安全设置激活对LM和NTLMv1使用的删除和阻止。  
转向使用NTLMv2和Kerberos协议，最好是长期使用Kerberos协议\(尽管这不能解决所有的安全问题\)。

### 过于信任–太多的信任或没有适当安全控制的信任 <a id="%E8%BF%87%E4%BA%8E%E4%BF%A1%E4%BB%BB%E2%80%93%E5%A4%AA%E5%A4%9A%E7%9A%84%E4%BF%A1%E4%BB%BB%E6%88%96%E6%B2%A1%E6%9C%89%E9%80%82%E5%BD%93%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6%E7%9A%84%E4%BF%A1%E4%BB%BB"></a>

要问的第一个问题是，“如果我删除了这个信任，会影响到什么?”如果答案是“我不知道”或“我不确定”，最好是禁用或删除信任。此外，重要的是评估“选择性身份验证”是否适合在任何或所有现有信任上启用。

需要定期\(可能是每年\)重新评估林和域信任，以确保信任关系仍然是必需的、正确的\(的确需要双向信任\)，并且是在安全可控制范围内的。如果未将信任配置为筛选SID筛选\(隔离\)，则存在可能无法很好理解的安全风险。

### 不隔离关键服务器之类的网络资源 <a id="%E4%B8%8D%E9%9A%94%E7%A6%BB%E5%85%B3%E9%94%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B9%8B%E7%B1%BB%E7%9A%84%E7%BD%91%E7%BB%9C%E8%B5%84%E6%BA%90"></a>

大多数内部网络是扁平的:任何计算机通常可以连接到任何其他计算机，这意味着任何工作站通常可以连接到任何服务器，包括关键资产，如财务或人力资源数据库。  
鉴于目前的威胁状况，这种模式需要改变。从网络上的任意计算机直接访问关键服务器是不合适的。  
考虑到企业内部的重要服务器通常运行Windows 2003或更早版本,并允许连接内部网络上的任何地方。这是一件“非常糟糕的事情”。  
至少可以做的是将这些系统的连通性限制在那些需要访问的系统上\(这包括在需要时代理访问\)。

